# This is a basic workflow to help you get started with Actions

name: build and deploy

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  pull_request:
    types:
      - labeled
      - unlabeled
      - synchronize
      - opened
      - edited
      - ready_for_review
      - reopened
      - unlocked
  pull_request_review:
    types:
      - submitted
  check_suite:
    types:
      - completed    
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # build job
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
     # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
     - uses: actions/checkout@v2
     # use node version 12.x
     - uses: actions/setup-node@v1
       with:
        node-version: '12.x'
        check-latest: true
     
     - name: Get yarn cache directory path
       id: yarn-cache-dir-path
       run: echo "::set-output name=dir::$(yarn cache dir)"

     - uses: actions/cache@v2
       id: yarn-cache # use this to check for `cache-hit` (`steps.yarn-cache.outputs.cache-hit != 'true'`)
       with:
         path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
         key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
         restore-keys: |
                ${{ runner.os }}-yarn-
     - run: yarn install
     - name: Deploy
       run: yarn run deploy
  # auto merge job
  automerge:
      runs-on: ubuntu-latest
      needs: build
      steps:
        - name: Merge pull requests
          uses: pascalgn/automerge-action@v0.9.0
          env:
            GITHUB_TOKEN: "${{ secrets.AUTO_MERGE_TOKEN }}"
            MERGE_COMMIT_MESSAGE: "pull-request-title-and-description"
            MERGE_LABELS: "netlify-cms/draft"
            MERGE_DELETE_BRANCH: true
